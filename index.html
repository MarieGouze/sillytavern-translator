<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>üê± ÂñµÂñµËßíËâ≤Âç°Â∑•Âùä</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>

    <style>
      :root {
        --sky: #66ccff;
        --sky-soft: #9fdfff;
        --sky-pale: #d6f2ff;
        --sky-muted: #b8e6ff;
        
        --cream: #fff9ed;
        --cream-soft: #fff5e0;
        --cream-deep: #ffefd0;
        --butter: #fffbf0;
        
        --blush: #ffe8ec;
        --blush-soft: #fff0f3;
        --rose: #ffd4dc;
        
        --mint: #e2f5f0;
        --mint-soft: #d0f0e8;
        --mint-dark: #7cc9b8;
        
        --lavender: #f0edf8;
        --lavender-soft: #e8e4f3;
        
        --peach: #fff0e5;
        --peach-soft: #ffe8d8;
        
        --text: #6b7280;
        --text-soft: #9ca3af;
        --text-dark: #4b5563;
        
        --white: #ffffff;
        --border: #e8f4fc;
        --shadow: rgba(102, 204, 255, 0.12);
        --shadow-soft: rgba(102, 204, 255, 0.08);
        
        --radius-sm: 12px;
        --radius-md: 18px;
        --radius-lg: 24px;
        --radius-xl: 32px;
        
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      [data-theme="dark"] {
        --sky: #5cb8e8;
        --sky-soft: #4a9ac7;
        --sky-pale: #2a3a45;
        --sky-muted: #3d5a6a;
        
        --cream: #1a1a2e;
        --cream-soft: #222238;
        --cream-deep: #2a2a42;
        --butter: #1e1e32;
        
        --blush: #3a2a32;
        --blush-soft: #2e2228;
        --rose: #4a3a42;
        
        --mint: #2a3a38;
        --mint-soft: #223230;
        --mint-dark: #5a9a8a;
        
        --lavender: #2a2838;
        --lavender-soft: #222230;
        
        --peach: #3a3228;
        --peach-soft: #2e2820;
        
        --text: #c8c8d8;
        --text-soft: #8888a8;
        --text-dark: #e0e0f0;
        
        --white: #252540;
        --border: #3a3a55;
        --shadow: rgba(0, 0, 0, 0.3);
        --shadow-soft: rgba(0, 0, 0, 0.2);
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      html, body {
        height: 100%;
        font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(160deg, var(--cream) 0%, var(--sky-pale) 50%, var(--lavender) 100%);
        background-attachment: fixed;
        color: var(--text);
        line-height: 1.6;
      }
      
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='50' font-size='40' opacity='0.025'%3Eüêæ%3C/text%3E%3C/svg%3E");
        background-size: 100px 100px;
        pointer-events: none;
        z-index: -1;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      
      /* ========== Header ========== */
      .header {
        background: linear-gradient(135deg, var(--sky) 0%, var(--sky-soft) 100%);
        border-radius: var(--radius-xl);
        padding: 20px 28px;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        position: relative;
        overflow: hidden;
      }
      
      .header::before {
        content: 'üêæ';
        position: absolute;
        right: 20px;
        top: -10px;
        font-size: 80px;
        opacity: 0.1;
        transform: rotate(15deg);
      }
      
      .header-title {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #fff;
        font-size: 22px;
        font-weight: 700;
        text-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .header-title .cat-icon {
        font-size: 32px;
        animation: bounce 2s infinite;
      }
      
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
      }
      
      .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        position: relative;
        z-index: 1;
      }
      
      .header-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: rgba(255,255,255,0.25);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255,255,255,0.4);
        border-radius: var(--radius-md);
        color: #fff;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        white-space: nowrap;
      }
      
      .header-btn:hover:not(:disabled) {
        background: rgba(255,255,255,0.4);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }
      
      .header-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .header-select {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        background: rgba(255,255,255,0.25);
        border: 2px solid rgba(255,255,255,0.4);
        border-radius: var(--radius-md);
        color: #fff;
        font-size: 13px;
      }
      
      .header-select select {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        outline: none;
        max-width: 140px;
      }
      
      .header-select select option {
        color: var(--text);
        background: var(--white);
      }
      
      /* ========== Upload Area ========== */
      .upload-area {
        background: var(--white);
        border: 3px dashed var(--sky-muted);
        border-radius: var(--radius-xl);
        padding: 60px 40px;
        text-align: center;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      
      .upload-area::before {
        content: 'üê±';
        position: absolute;
        font-size: 150px;
        opacity: 0.04;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      
      .upload-area.drag-over {
        border-color: var(--sky);
        background: var(--sky-pale);
        transform: scale(1.01);
      }
      
      .upload-icon {
        font-size: 64px;
        margin-bottom: 16px;
        animation: float 3s ease-in-out infinite;
      }
      
      @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
      }
      
      .upload-text {
        color: var(--text-soft);
        font-size: 16px;
        margin-bottom: 24px;
      }
      
      .upload-hint {
        color: var(--text-soft);
        font-size: 13px;
        margin-top: 16px;
      }
      
      .upload-buttons {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      /* History Section */
      .history-section {
        margin-top: 30px;
        padding-top: 24px;
        border-top: 2px dashed var(--cream-deep);
      }
      
      .history-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-soft);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .history-list {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .history-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        background: var(--cream);
        border: 2px solid var(--cream-deep);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: var(--transition);
        max-width: 200px;
      }
      
      .history-item:hover {
        background: var(--sky-pale);
        border-color: var(--sky-muted);
      }
      
      .history-item img {
        width: 36px;
        height: 48px;
        object-fit: cover;
        border-radius: 6px;
      }
      
      .history-item .placeholder {
        width: 36px;
        height: 48px;
        background: var(--cream-deep);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
      
      .history-item .info {
        flex: 1;
        min-width: 0;
      }
      
      .history-item .name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .history-item .date {
        font-size: 11px;
        color: var(--text-soft);
      }
      
      .history-item .delete {
        padding: 4px 8px;
        background: var(--blush);
        border: none;
        border-radius: 6px;
        color: #c9939c;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        transition: var(--transition);
      }
      
      .history-item:hover .delete {
        opacity: 1;
      }
      
      .history-item .delete:hover {
        background: var(--rose);
      }
      
      /* ========== Buttons ========== */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 14px 28px;
        border: none;
        border-radius: var(--radius-lg);
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      
      .btn.primary {
        background: linear-gradient(135deg, var(--sky) 0%, var(--sky-soft) 100%);
        color: #fff;
        box-shadow: 0 4px 18px var(--shadow);
      }
      
      .btn.secondary {
        background: var(--cream-soft);
        color: var(--text);
        border: 2px solid var(--cream-deep);
      }
      
      .btn.success {
        background: linear-gradient(135deg, var(--mint-dark) 0%, var(--mint-soft) 100%);
        color: #fff;
        box-shadow: 0 4px 18px rgba(124, 201, 184, 0.4);
      }
      
      .btn.danger {
        background: linear-gradient(135deg, #e8a0a0 0%, var(--blush) 100%);
        color: #fff;
      }
      
      .btn:hover:not(:disabled) {
        transform: translateY(-3px) scale(1.02);
      }
      
      .btn:active:not(:disabled) {
        transform: translateY(-1px) scale(0.98);
      }
      
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
      }
      
      .btn::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
        transform: rotate(45deg) translateX(-100%);
        transition: 0.5s;
      }
      
      .btn:hover::after {
        transform: rotate(45deg) translateX(100%);
      }
      
      .btn-sm {
        padding: 5px 10px;
        font-size: 11px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 3px;
      }
      
      .btn-sm.sky {
        background: var(--sky-pale);
        color: var(--sky);
      }
      
      .btn-sm.blush {
        background: var(--blush);
        color: #c9939c;
      }
      
      .btn-sm.mint {
        background: var(--mint);
        color: var(--mint-dark);
      }
      
      .btn-sm.lavender {
        background: var(--lavender);
        color: #8080a0;
      }
      
      .btn-sm.peach {
        background: var(--peach);
        color: #c9a080;
      }
      
      .btn-sm:hover:not(:disabled) {
        transform: scale(1.05);
        filter: brightness(0.95);
      }
      
      .btn-sm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .hidden { display: none !important; }
      
      /* ========== File Bar ========== */
      .file-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        padding: 14px 24px;
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: 0 4px 20px var(--shadow-soft);
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      
      .file-bar .file-icon { font-size: 24px; }
      .file-bar .file-name { font-weight: 600; color: var(--text-dark); }
      
      .file-bar .auto-save {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        color: var(--mint-dark);
        padding: 5px 10px;
        background: var(--mint);
        border-radius: var(--radius-sm);
      }
      
      .file-bar .close-btn {
        padding: 6px 14px;
        background: var(--blush);
        border: none;
        border-radius: var(--radius-sm);
        color: #c9939c;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }
      
      .file-bar .close-btn:hover {
        background: var(--rose);
      }
      
      /* ========== Main Card ========== */
      .main-card {
        background: var(--white);
        border-radius: var(--radius-xl);
        box-shadow: 0 10px 40px var(--shadow-soft);
        overflow: hidden;
      }
      
      /* ========== Character Info ========== */
      .char-info {
        display: flex;
        gap: 24px;
        padding: 28px;
        background: linear-gradient(135deg, var(--cream) 0%, var(--peach-soft) 100%);
        position: relative;
      }
      
      .char-info::before {
        content: '‚ú®';
        position: absolute;
        right: 30px;
        top: 20px;
        font-size: 24px;
        animation: sparkle 1.5s infinite;
      }
      
      @keyframes sparkle {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.8); }
      }
      
      .char-avatar {
        flex: 0 0 220px;
      }
      
      .char-avatar-box {
        width: 100%;
        aspect-ratio: 3/4;
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: var(--white);
        border: 4px solid var(--white);
        box-shadow: 0 6px 24px var(--shadow-soft);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        color: var(--text-soft);
      }
      
      .char-avatar-box:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 40px var(--shadow);
      }
      
      .char-avatar-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .char-avatar-box .placeholder-icon {
        font-size: 48px;
        opacity: 0.5;
      }
      
      .char-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .spec-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        background: var(--sky-pale);
        border-radius: 20px;
        color: var(--sky);
        font-size: 12px;
        font-weight: 700;
        width: fit-content;
      }
      
      .field-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .field-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-soft);
      }
      
      .field-label .actions {
        display: flex;
        gap: 6px;
      }
      
      .input {
        width: 100%;
        padding: 14px 18px;
        background: var(--white);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        transition: var(--transition);
        font-family: inherit;
      }
      
      .input:focus {
        outline: none;
        border-color: var(--sky-muted);
        box-shadow: 0 0 0 4px var(--sky-pale);
      }
      
      .input::placeholder {
        color: var(--text-soft);
        font-weight: 400;
      }
      
      /* ========== Tabs ========== */
      .tabs {
        display: flex;
        gap: 8px;
        padding: 16px 24px;
        background: var(--cream);
        border-bottom: 2px solid var(--cream-deep);
        overflow-x: auto;
        align-items: center;
      }
      
      .tab-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: transparent;
        border: 2px solid transparent;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-soft);
        cursor: pointer;
        transition: var(--transition);
        white-space: nowrap;
      }
      
      .tab-btn:hover {
        background: var(--white);
        color: var(--text);
      }
      
      .tab-btn.active {
        background: var(--white);
        border-color: var(--sky-muted);
        color: var(--sky);
        box-shadow: 0 4px 15px var(--shadow-soft);
      }
      
      .tab-btn .badge {
        background: var(--blush);
        color: #c9939c;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
      }
      
      .tabs-spacer {
        flex: 1;
      }
      
      .clear-all-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: var(--blush);
        border: 2px solid var(--rose);
        border-radius: var(--radius-md);
        color: #c9939c;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        white-space: nowrap;
      }
      
      .clear-all-btn:hover {
        background: var(--rose);
        color: #fff;
      }
      
      /* ========== Tab Content ========== */
      .tab-content {
        padding: 24px;
      }
      
      .batch-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      
      .section-card {
        background: var(--cream);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 2px dashed var(--cream-deep);
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        font-weight: 700;
        color: var(--text-dark);
      }
      
      .section-tools {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      
      .char-count {
        font-size: 11px;
        color: var(--text-soft);
        padding: 4px 10px;
        background: var(--white);
        border-radius: var(--radius-sm);
      }
      
      .textarea {
        width: 100%;
        min-height: 120px;
        padding: 16px;
        background: var(--white);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        line-height: 1.7;
        color: var(--text);
        resize: vertical;
        transition: var(--transition);
        font-family: inherit;
      }
      
      .textarea:focus {
        outline: none;
        border-color: var(--sky-muted);
        box-shadow: 0 0 0 4px var(--sky-pale);
      }
      
      /* ========== World Book ========== */
      .book-toolbar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      
      .search-box {
        flex: 1;
        min-width: 200px;
        position: relative;
      }
      
      .search-box input {
        width: 100%;
        padding: 12px 16px 12px 42px;
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        background: var(--white);
        color: var(--text);
      }
      
      .search-box input:focus {
        outline: none;
        border-color: var(--sky-muted);
      }
      
      .search-box::before {
        content: 'üîç';
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        opacity: 0.5;
      }
      
      .book-entry {
        background: var(--white);
        border: 2px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        margin-bottom: 16px;
        transition: var(--transition);
      }
      
      .book-entry:hover {
        border-color: var(--sky-muted);
        box-shadow: 0 4px 20px var(--shadow-soft);
      }
      
      .book-entry.collapsed .entry-body {
        display: none;
      }
      
      .entry-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 18px;
        background: var(--cream);
        border-bottom: 2px solid var(--border);
        cursor: pointer;
        gap: 12px;
      }
      
      .entry-header .collapse-icon {
        font-size: 14px;
        transition: var(--transition);
        opacity: 0.6;
      }
      
      .book-entry.collapsed .entry-header .collapse-icon {
        transform: rotate(-90deg);
      }
      
      .entry-header input {
        flex: 1;
        background: transparent;
        border: none;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-dark);
        outline: none;
        min-width: 0;
      }
      
      .entry-header .entry-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
      }
      
      .entry-body {
        padding: 18px;
      }
      
      .entry-row {
        margin-bottom: 14px;
      }
      
      .entry-row label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-soft);
        margin-bottom: 6px;
      }
      
      .entry-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 14px;
        padding-top: 14px;
        border-top: 2px dashed var(--cream-deep);
      }
      
      .grid-field {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .grid-field label {
        font-size: 12px;
        color: var(--text-soft);
        white-space: nowrap;
      }
      
      .grid-field input[type="number"] {
        width: 70px;
        padding: 8px 10px;
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: 13px;
        text-align: center;
        background: var(--white);
        color: var(--text);
      }
      
      /* ========== Toggle ========== */
      .toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-soft);
      }
      
      .toggle input { display: none; }
      
      .toggle-track {
        width: 44px;
        height: 24px;
        background: var(--cream-deep);
        border-radius: 12px;
        position: relative;
        transition: var(--transition);
      }
      
      .toggle-track::before {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        background: var(--white);
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: var(--transition);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .toggle input:checked + .toggle-track {
        background: var(--sky-muted);
      }
      
      .toggle input:checked + .toggle-track::before {
        transform: translateX(20px);
      }
      
      /* ========== Export Section ========== */
      .export-section {
        padding: 30px;
        text-align: center;
        border-top: 2px dashed var(--cream-deep);
        background: var(--cream);
      }
      
      .export-btn {
        padding: 16px 48px;
        background: linear-gradient(135deg, var(--mint-dark) 0%, var(--mint-soft) 100%);
        border: none;
        border-radius: var(--radius-lg);
        color: #fff;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 6px 24px rgba(124, 201, 184, 0.4);
      }
      
      .export-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 10px 35px rgba(124, 201, 184, 0.5);
      }
      
      .export-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      
      /* ========== Modal ========== */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(107, 114, 128, 0.4);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        animation: fadeIn 0.2s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .modal {
        background: var(--white);
        border-radius: var(--radius-xl);
        width: 100%;
        max-width: 600px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px var(--shadow);
        animation: slideUp 0.3s ease;
        overflow: hidden;
      }
      
      .modal.large { max-width: 1000px; }
      .modal.fullscreen { max-width: 95vw; max-height: 90vh; }
      
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        background: linear-gradient(135deg, var(--sky) 0%, var(--sky-soft) 100%);
        color: #fff;
        flex-shrink: 0;
      }
      
      .modal-header.danger {
        background: linear-gradient(135deg, #e8a0a0 0%, var(--rose) 100%);
      }
      
      .modal-header.success {
        background: linear-gradient(135deg, var(--mint-dark) 0%, var(--mint-soft) 100%);
      }
      
      .modal-header h2 {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .modal-close {
        width: 32px;
        height: 32px;
        background: rgba(255,255,255,0.2);
        border: none;
        border-radius: 50%;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-close:hover {
        background: rgba(255,255,255,0.4);
        transform: rotate(90deg);
      }
      
      .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }
      
      .modal-footer {
        padding: 16px 24px;
        background: var(--cream);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        border-top: 2px solid var(--cream-deep);
        flex-shrink: 0;
      }
      
      /* Export Options */
      .export-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .export-option {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px;
        background: var(--cream);
        border: 2px solid var(--cream-deep);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: var(--transition);
      }
      
      .export-option:hover {
        background: var(--sky-pale);
        border-color: var(--sky-muted);
      }
      
      .export-option .icon {
        font-size: 32px;
      }
      
      .export-option .info {
        flex: 1;
      }
      
      .export-option .title {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 4px;
      }
      
      .export-option .desc {
        font-size: 12px;
        color: var(--text-soft);
      }
      
      /* Full Editor Modal */
      .full-editor-textarea {
        width: 100%;
        height: calc(90vh - 200px);
        min-height: 400px;
        padding: 20px;
        background: var(--white);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 15px;
        line-height: 1.8;
        color: var(--text);
        resize: none;
        font-family: inherit;
      }
      
      .full-editor-textarea:focus {
        outline: none;
        border-color: var(--sky-muted);
      }
      
      /* ========== Form Group ========== */
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-soft);
        margin-bottom: 8px;
      }
      
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
        transition: var(--transition);
        background: var(--white);
        color: var(--text);
      }
      
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--sky-muted);
      }
      
      .form-group textarea {
        min-height: 120px;
        resize: vertical;
      }
      
      /* Template List */
      .template-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px dashed var(--cream-deep);
      }
      
      .template-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      
      .template-header h4 {
        font-size: 14px;
        color: var(--text-dark);
      }
      
      .template-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--cream);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        cursor: pointer;
        transition: var(--transition);
      }
      
      .template-item:hover {
        background: var(--sky-pale);
      }
      
      .template-item .name {
        font-weight: 600;
        color: var(--text-dark);
      }
      
      .template-item .btns {
        display: flex;
        gap: 6px;
      }
      
      /* ========== Checkbox ========== */
      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--cream);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        cursor: pointer;
        transition: var(--transition);
      }
      
      .checkbox-item:hover {
        background: var(--sky-pale);
      }
      
      .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: var(--sky);
      }
      
      /* ========== Provider ========== */
      .provider-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 18px;
        background: var(--cream);
        border-radius: var(--radius-md);
        margin-bottom: 10px;
      }
      
      .provider-item .name {
        font-weight: 600;
        color: var(--text-dark);
      }
      
      .provider-item .btns {
        display: flex;
        gap: 8px;
      }
      
      /* ========== Translation Compare ========== */
      .compare-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: var(--cream);
        border-bottom: 2px solid var(--cream-deep);
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .progress-bar {
        flex: 1;
        max-width: 300px;
        height: 10px;
        background: var(--cream-deep);
        border-radius: 5px;
        overflow: hidden;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--sky), var(--mint-dark));
        transition: width 0.3s ease;
        border-radius: 5px;
      }
      
      .stats {
        display: flex;
        gap: 16px;
        font-size: 13px;
        font-weight: 600;
      }
      
      .stat { display: flex; align-items: center; gap: 4px; }
      .stat.success { color: var(--mint-dark); }
      .stat.error { color: #c9939c; }
      .stat.pending { color: var(--text-soft); }
      
      .compare-item {
        background: var(--cream);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 14px;
        border: 2px solid var(--cream-deep);
        transition: var(--transition);
        animation: itemIn 0.3s ease;
      }
      
      @keyframes itemIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .compare-item.translating {
        border-color: var(--sky-muted);
        background: var(--sky-pale);
      }
      
      .compare-item.success { border-color: var(--mint-soft); }
      
      .compare-item.error {
        border-color: var(--rose);
        background: var(--blush-soft);
      }
      
      .compare-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      
      .compare-item-header label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: var(--text-dark);
      }
      
      .status-badge {
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
      }
      
      .status-badge.pending { background: var(--cream-deep); color: var(--text-soft); }
      .status-badge.translating { background: var(--sky-pale); color: var(--sky); animation: pulse 1.5s infinite; }
      .status-badge.success { background: var(--mint); color: var(--mint-dark); }
      .status-badge.error { background: var(--blush); color: #c9939c; }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
      
      .compare-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      
      .compare-col h4 {
        font-size: 12px;
        color: var(--text-soft);
        margin-bottom: 8px;
      }
      
      .compare-box {
        padding: 12px;
        border-radius: var(--radius-sm);
        font-size: 13px;
        line-height: 1.6;
        max-height: 150px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-word;
      }
      
      .compare-col.original .compare-box {
        background: var(--peach-soft);
        border: 1px solid var(--peach);
      }
      
      .compare-col.translated .compare-box {
        background: var(--mint);
        border: 1px solid var(--mint-soft);
      }
      
      .compare-col.translated .compare-box.pending {
        background: var(--cream);
        border-color: var(--cream-deep);
        color: var(--text-soft);
      }
      
      /* ========== Toast ========== */
      .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .toast {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 20px;
        background: var(--white);
        border-radius: var(--radius-md);
        box-shadow: 0 8px 30px var(--shadow);
        animation: toastIn 0.3s ease;
        border-left: 4px solid var(--sky);
        min-width: 260px;
      }
      
      .toast.success { border-left-color: var(--mint-dark); }
      .toast.error { border-left-color: #c9939c; }
      .toast.warning { border-left-color: var(--peach); }
      
      @keyframes toastIn {
        from { opacity: 0; transform: translateX(50px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      .toast-icon { font-size: 20px; }
      .toast-message { font-weight: 500; color: var(--text-dark); }
      
      /* ========== Loading ========== */
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 249, 237, 0.9);
        backdrop-filter: blur(8px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        gap: 20px;
      }
      
      [data-theme="dark"] .loading-overlay {
        background: rgba(26, 26, 46, 0.9);
      }
      
      .loading-cat {
        font-size: 64px;
        animation: catBounce 0.6s infinite alternate;
      }
      
      @keyframes catBounce {
        from { transform: translateY(0) rotate(-5deg); }
        to { transform: translateY(-15px) rotate(5deg); }
      }
      
      .loading-text {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
      }
      
      .loading-dots::after {
        content: '';
        animation: dots 1.5s infinite;
      }
      
      @keyframes dots {
        0% { content: ''; }
        25% { content: '.'; }
        50% { content: '..'; }
        75% { content: '...'; }
      }
      
      /* ========== Responsive ========== */
      @media (max-width: 768px) {
        .header { flex-direction: column; text-align: center; }
        .char-info { flex-direction: column; }
        .char-avatar { flex: none; max-width: 180px; margin: 0 auto; }
        .compare-grid { grid-template-columns: 1fr; }
        .upload-buttons { flex-direction: column; }
        .tabs { flex-wrap: wrap; }
        .section-tools { justify-content: flex-end; width: 100%; }
        .history-item { max-width: 100%; }
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import { GoogleGenerativeAI } from "@google/generative-ai";

      const { useState, useEffect, useCallback, useMemo, useRef, memo } = React;

      // ================== Constants ==================
      const PNG_SIGNATURE = [137, 80, 78, 71, 13, 10, 26, 10];
      const CHUNK_SIZE = 6;
      const AUTO_SAVE_KEY = 'charCardAutoSave';
      const HISTORY_KEY = 'charCardHistory';
      const TEMPLATES_KEY = 'promptTemplates';
      const MAX_HISTORY = 10;
      const MAX_UNDO = 50;
      
      const DEFAULT_PROMPTS = {
        name: "‰∏∫Ëøô‰∏™ËßíËâ≤Ëµ∑‰∏Ä‰∏™ÂèØÁà±ÁöÑÁÆÄ‰Ωì‰∏≠ÊñáÂêçÁß∞„ÄÇ",
        tags: "ÂàóÂá∫5-8‰∏™ÊèèËø∞Ëøô‰∏™ËßíËâ≤ÁöÑÁÆÄ‰Ωì‰∏≠ÊñáÊ†áÁ≠æÔºåÁî®ÈÄóÂè∑ÂàÜÈöî„ÄÇ",
        description: "Áî®ÁÆÄ‰Ωì‰∏≠ÊñáËØ¶ÁªÜÊèèËø∞Ëøô‰∏™ËßíËâ≤ÁöÑÂ§ñË≤å„ÄÅÊÄßÊ†ºÂíåËÉåÊôØ„ÄÇ",
        first_message: "‰∏∫Ëøô‰∏™ËßíËâ≤ÂÜô‰∏ÄÊÆµÊúâË∂£ÁöÑÂºÄÂú∫ÁôΩ„ÄÇ",
        message_example: "ÂÜô‰∏ÄÊÆµËÉΩ‰ΩìÁé∞ËßíËâ≤ÊÄßÊ†ºÁöÑÂØπËØùÁ§∫‰æã„ÄÇ",
        alternate_greetings: "ÂÜô‰∏âÊù°‰∏çÂêåÈ£éÊ†ºÁöÑÈóÆÂÄôËØ≠ÔºåÁî® ||| ÂàÜÈöî„ÄÇ"
      };

      // ================== Utils ==================
      const isValidPNG = (bytes) => bytes?.length >= 8 && PNG_SIGNATURE.every((v, i) => bytes[i] === v);

      const crc32 = (bytes) => {
        let crc = 0xFFFFFFFF;
        const table = Array.from({length: 256}, (_, n) => {
          let c = n;
          for (let k = 0; k < 8; k++) c = c & 1 ? 0xEDB88320 ^ (c >>> 1) : c >>> 1;
          return c;
        });
        for (let i = 0; i < bytes.length; i++) crc = table[(crc ^ bytes[i]) & 0xFF] ^ (crc >>> 8);
        return (crc ^ 0xFFFFFFFF) >>> 0;
      };

      const createTextChunk = (keyword, text) => {
        const keyBytes = new TextEncoder().encode(keyword);
        const textBytes = new TextEncoder().encode(text);
        const data = new Uint8Array(keyBytes.length + 1 + textBytes.length);
        data.set(keyBytes);
        data.set(textBytes, keyBytes.length + 1);
        const chunk = new Uint8Array(12 + data.length);
        new DataView(chunk.buffer).setUint32(0, data.length);
        chunk.set(new TextEncoder().encode('tEXt'), 4);
        chunk.set(data, 8);
        new DataView(chunk.buffer).setUint32(8 + data.length, crc32(chunk.slice(4, 8 + data.length)));
        return chunk;
      };

      const encodeBase64 = (str) => btoa(String.fromCharCode(...new TextEncoder().encode(str)));
      const decodeBase64 = (b64) => new TextDecoder().decode(Uint8Array.from(atob(b64), c => c.charCodeAt(0)));
      const countChars = (s) => (s || '').length;

      const copyToClipboard = async (text) => {
        try {
          await navigator.clipboard.writeText(text || '');
          return true;
        } catch {
          return false;
        }
      };

      const formatDate = (date) => {
        const d = new Date(date);
        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      };

      // ================== Hooks ==================
      const useLocalStorage = (key, defaultVal) => {
        const [val, setVal] = useState(() => {
          try { return JSON.parse(localStorage.getItem(key)) ?? defaultVal; }
          catch { return defaultVal; }
        });
        useEffect(() => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }, [key, val]);
        return [val, setVal];
      };

      const useToast = () => {
        const [toasts, setToasts] = useState([]);
        const addToast = useCallback((msg, type = 'info') => {
          const id = Date.now();
          setToasts(p => [...p, { id, msg, type }]);
          setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000);
        }, []);
        return { toasts, addToast };
      };

      const useTheme = () => {
        const [theme, setTheme] = useLocalStorage('theme', 'light');
        useEffect(() => { document.documentElement.setAttribute('data-theme', theme); }, [theme]);
        const toggle = useCallback(() => setTheme(t => t === 'light' ? 'dark' : 'light'), []);
        return { theme, toggle };
      };

      const useHistory = () => {
        const [history, setHistory] = useLocalStorage(HISTORY_KEY, []);
        
        const addToHistory = useCallback((item) => {
          setHistory(prev => {
            const filtered = prev.filter(h => h.name !== item.name);
            return [{ ...item, date: Date.now() }, ...filtered].slice(0, MAX_HISTORY);
          });
        }, []);
        
        const removeFromHistory = useCallback((name) => {
          setHistory(prev => prev.filter(h => h.name !== name));
        }, []);
        
        const clearHistory = useCallback(() => setHistory([]), []);
        
        return { history, addToHistory, removeFromHistory, clearHistory };
      };

      const useUndo = (initialState) => {
        const [past, setPast] = useState([]);
        const [present, setPresent] = useState(initialState);
        const [future, setFuture] = useState([]);
        
        const canUndo = past.length > 0;
        const canRedo = future.length > 0;
        
        const set = useCallback((newState, skipHistory = false) => {
          if (skipHistory) {
            setPresent(newState);
            return;
          }
          setPresent(prev => {
            if (JSON.stringify(prev) !== JSON.stringify(newState)) {
              setPast(p => [...p.slice(-MAX_UNDO), prev]);
              setFuture([]);
            }
            return newState;
          });
        }, []);
        
        const undo = useCallback(() => {
          if (past.length === 0) return;
          const previous = past[past.length - 1];
          setPast(p => p.slice(0, -1));
          setFuture(f => [present, ...f]);
          setPresent(previous);
        }, [past, present]);
        
        const redo = useCallback(() => {
          if (future.length === 0) return;
          const next = future[0];
          setFuture(f => f.slice(1));
          setPast(p => [...p, present]);
          setPresent(next);
        }, [future, present]);
        
        const reset = useCallback((newState) => {
          setPast([]);
          setFuture([]);
          setPresent(newState);
        }, []);
        
        return { state: present, set, undo, redo, canUndo, canRedo, reset };
      };

      // ================== API ==================
      const callAPI = async (parts, systemPrompt, { providers, providerIdx, model }) => {
        const provider = providers[providerIdx];
        if (!provider?.key) throw new Error("ËØ∑ÂÖàÈÖçÁΩÆAPIÂØÜÈí• üîë");

        const imagePart = parts.find(p => p.inlineData);

        if (provider.url) {
          const messages = imagePart
            ? [{ role: 'system', content: systemPrompt }, { role: 'user', content: parts.map(p => p.inlineData ? { type: 'image_url', image_url: { url: `data:${p.inlineData.mimeType};base64,${p.inlineData.data}` }} : { type: 'text', text: p }) }]
            : [{ role: 'system', content: systemPrompt }, { role: 'user', content: parts.join('\n') }];

          const resp = await fetch(provider.url.replace(/\/$/, '') + (provider.endpoint || '/chat/completions'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${provider.key}` },
            body: JSON.stringify({ model, messages, stream: false })
          });

          if (!resp.ok) throw new Error((await resp.json().catch(() => ({}))).error?.message || resp.statusText);
          return (await resp.json()).choices?.[0]?.message?.content || '';
        } else {
          const genAI = new GoogleGenerativeAI(provider.key);
          const genModel = genAI.getGenerativeModel({ model, systemInstruction: systemPrompt });
          return (await genModel.generateContent({ contents: [{ role: 'user', parts }] })).response.text();
        }
      };

      // ================== Components ==================
      const Toast = memo(({ toasts }) => (
        <div className="toast-container">
          {toasts.map(t => (
            <div key={t.id} className={`toast ${t.type}`}>
              <span className="toast-icon">{t.type === 'success' ? '‚úÖ' : t.type === 'error' ? '‚ùå' : 'üí°'}</span>
              <span className="toast-message">{t.msg}</span>
            </div>
          ))}
        </div>
      ));

      const LoadingOverlay = memo(({ message }) => (
        <div className="loading-overlay">
          <div className="loading-cat">üê±</div>
          <div className="loading-text">{message}<span className="loading-dots"></span></div>
        </div>
      ));

      const Toggle = memo(({ label, checked, onChange }) => (
        <label className="toggle">
          <input type="checkbox" checked={!!checked} onChange={e => onChange(e.target.checked)} />
          <span className="toggle-track" />
          {label && <span>{label}</span>}
        </label>
      ));

      const Modal = memo(({ show, onClose, title, children, footer, large, fullscreen, headerClass, canClose = true }) => {
        if (!show) return null;
        return (
          <div className="modal-overlay" onClick={canClose ? onClose : undefined}>
            <div className={`modal ${large ? 'large' : ''} ${fullscreen ? 'fullscreen' : ''}`} onClick={e => e.stopPropagation()}>
              <div className={`modal-header ${headerClass || ''}`}>
                <h2>{title}</h2>
                {canClose && <button className="modal-close" onClick={onClose}>√ó</button>}
              </div>
              <div className="modal-body">{children}</div>
              {footer && <div className="modal-footer">{footer}</div>}
            </div>
          </div>
        );
      });

      // Export Options Modal
      const ExportModal = memo(({ show, onClose, onExport }) => {
        if (!show) return null;
        return (
          <Modal show onClose={onClose} title="üíæ ÂØºÂá∫ËßíËâ≤Âç°" headerClass="success">
            <div className="export-options">
              <div className="export-option" onClick={() => onExport('png')}>
                <span className="icon">üñºÔ∏è</span>
                <div className="info">
                  <div className="title">ÂØºÂá∫ PNG</div>
                  <div className="desc">ÂØºÂá∫ÂåÖÂê´ËßíËâ≤Êï∞ÊçÆÁöÑPNGÂõæÁâáÔºåÂèØÁõ¥Êé•ÂØºÂÖ•Âà∞SillyTavernÁ≠âÂâçÁ´Ø</div>
                </div>
              </div>
              <div className="export-option" onClick={() => onExport('json')}>
                <span className="icon">üìÑ</span>
                <div className="info">
                  <div className="title">ÂØºÂá∫ JSON</div>
                  <div className="desc">ÂØºÂá∫Á∫ØÊï∞ÊçÆJSONÊñá‰ª∂ÔºåÊñπ‰æøÂ§á‰ªΩÂíåÁºñËæë</div>
                </div>
              </div>
              <div className="export-option" onClick={() => onExport('both')}>
                <span className="icon">üì¶</span>
                <div className="info">
                  <div className="title">ÂØºÂá∫ PNG + JSON</div>
                  <div className="desc">ÂêåÊó∂ÂØºÂá∫‰∏§ÁßçÊ†ºÂºè</div>
                </div>
              </div>
            </div>
          </Modal>
        );
      });

      // Full Screen Editor Modal
      const FullEditorModal = memo(({ show, onClose, title, value, onChange }) => {
        const [text, setText] = useState('');
        useEffect(() => { if (show) setText(value || ''); }, [show, value]);
        if (!show) return null;

        const handleSave = () => { onChange(text); onClose(); };

        return (
          <Modal show fullscreen title={title} onClose={onClose} footer={
            <>
              <span style={{ marginRight: 'auto', color: 'var(--text-soft)', fontSize: 13 }}>{countChars(text)} Â≠ó</span>
              <button className="btn primary" onClick={handleSave}>üíæ ‰øùÂ≠ò</button>
              <button className="btn secondary" onClick={onClose}>ÂèñÊ∂à</button>
            </>
          }>
            <textarea className="full-editor-textarea" value={text} onChange={e => setText(e.target.value)} autoFocus />
          </Modal>
        );
      });

      // Clear All Confirm Modal
      const ClearAllModal = memo(({ show, onClose, onConfirm }) => {
        if (!show) return null;
        return (
          <Modal show onClose={onClose} title="‚ö†Ô∏è Á°ÆËÆ§Ê∏ÖÁ©∫" headerClass="danger" footer={
            <>
              <button className="btn danger" onClick={onConfirm}>üóëÔ∏è Á°ÆËÆ§Ê∏ÖÁ©∫</button>
              <button className="btn secondary" onClick={onClose}>ÂèñÊ∂à</button>
            </>
          }>
            <p style={{ fontSize: 15, marginBottom: 16 }}>Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπÂêóÔºü</p>
            <p style={{ color: 'var(--text-soft)', fontSize: 13 }}>ËøôÂ∞ÜÊ∏ÖÁ©∫ËßíËâ≤ÂêçÁß∞„ÄÅÊèèËø∞„ÄÅÊÄßÊ†º„ÄÅÂú∫ÊôØ„ÄÅÂºÄÂú∫ÁôΩ„ÄÅÂØπËØùÁ§∫‰æã„ÄÅÊ†áÁ≠æ„ÄÅÈóÆÂÄôËØ≠Âíå‰∏ñÁïå‰π¶Á≠âÊâÄÊúâÂÜÖÂÆπ„ÄÇÊ≠§Êìç‰ΩúÂèØÈÄöËøáÊí§ÈîÄÂäüËÉΩÊÅ¢Â§ç„ÄÇ</p>
          </Modal>
        );
      });

      const FieldSection = memo(({ icon, title, fieldKey, value, onChange, onGenerate, onExpand, onCopy, onClear, onUndo, onRedo, canUndo, canRedo, disabled, rows = 4 }) => {
        const handleCopy = async () => {
          const success = await copyToClipboard(value);
          onCopy(success);
        };

        return (
          <div className="section-card">
            <div className="section-header">
              <span className="section-title">{icon} {title}</span>
              <div className="section-tools">
                <button className="btn-sm peach" onClick={onUndo} disabled={!canUndo} title="Êí§ÈîÄ">‚Ü∂</button>
                <button className="btn-sm peach" onClick={onRedo} disabled={!canRedo} title="ÈáçÂÅö">‚Ü∑</button>
                <button className="btn-sm lavender" onClick={() => onExpand(fieldKey, title)} title="ÂÖ®Â±èÁºñËæë">‚õ∂ Â±ïÂºÄ</button>
                <button className="btn-sm mint" onClick={handleCopy} title="Â§çÂà∂ÂÜÖÂÆπ">üìã Â§çÂà∂</button>
                <button className="btn-sm blush" onClick={() => onClear(fieldKey)} title="Ê∏ÖÁ©∫ÂÜÖÂÆπ">üóëÔ∏è Ê∏ÖÁ©∫</button>
                <span className="char-count">{countChars(value)} Â≠ó</span>
                <button className="btn-sm sky" onClick={onGenerate} disabled={disabled}>‚ú® ÁîüÊàê</button>
              </div>
            </div>
            <textarea className="textarea" rows={rows} value={value || ''} onChange={e => onChange(e.target.value)} placeholder={`ËØ∑ËæìÂÖ•${title}...`} />
          </div>
        );
      });

      const BookEntry = memo(({ entry, index, onChange, onRemove, collapsed, onToggle }) => {
        const update = (k, v) => onChange(index, k, v);
        
        return (
          <div className={`book-entry ${collapsed ? 'collapsed' : ''}`}>
            <div className="entry-header" onClick={onToggle}>
              <span className="collapse-icon">‚ñº</span>
              <input value={entry.name || ''} onChange={e => { e.stopPropagation(); update('name', e.target.value); }} onClick={e => e.stopPropagation()} placeholder="Êù°ÁõÆÂêçÁß∞" />
              <div className="entry-actions" onClick={e => e.stopPropagation()}>
                <Toggle label="ÂêØÁî®" checked={entry.enabled} onChange={v => update('enabled', v)} />
                <button className="btn-sm blush" onClick={() => onRemove(index)}>Âà†Èô§</button>
              </div>
            </div>
            <div className="entry-body">
              <div className="entry-row">
                <label>üîë ÂÖ≥ÈîÆËØç</label>
                <input className="input" value={entry.keysText || ''} onChange={e => update('keysText', e.target.value)} placeholder="Áî®ÈÄóÂè∑ÂàÜÈöî" />
              </div>
              <div className="entry-row">
                <label>üìù ÂÜÖÂÆπ ({countChars(entry.content)} Â≠ó)</label>
                <textarea className="textarea" rows={3} value={entry.content || ''} onChange={e => update('content', e.target.value)} />
              </div>
              <div className="entry-grid">
                <div className="grid-field">
                  <label>‰ºòÂÖàÁ∫ß</label>
                  <input type="number" value={entry.insertion_order || 0} onChange={e => update('insertion_order', +e.target.value)} />
                </div>
                <div className="grid-field">
                  <label>Ê∑±Â∫¶</label>
                  <input type="number" value={entry.depth || 4} onChange={e => update('depth', +e.target.value)} />
                </div>
                <Toggle label="Â∏∏È©ª" checked={entry.constant} onChange={v => update('constant', v)} />
              </div>
            </div>
          </div>
        );
      });

      // Tabs
      const BasicTab = memo(({ data, onChange, onGen, onExpand, onCopy, onClear, onUndo, onRedo, canUndo, canRedo, disabled }) => (
        <div>
          <FieldSection icon="üìñ" title="ÊèèËø∞" fieldKey="description" value={data.description} onChange={v => onChange('description', v)} onGenerate={() => onGen('description')} onExpand={onExpand} onCopy={onCopy} onClear={onClear} onUndo={onUndo} onRedo={onRedo} canUndo={canUndo} canRedo={canRedo} disabled={disabled} rows={5} />
          <FieldSection icon="üí´" title="ÊÄßÊ†º" fieldKey="personality" value={data.personality} onChange={v => onChange('personality', v)} onGenerate={() => onGen('personality')} onExpand={onExpand} onCopy={onCopy} onClear={onClear} onUndo={onUndo} onRedo={onRedo} canUndo={canUndo} canRedo={canRedo} disabled={disabled} />
          <FieldSection icon="üé¨" title="Âú∫ÊôØ" fieldKey="scenario" value={data.scenario} onChange={v => onChange('scenario', v)} onGenerate={() => onGen('scenario')} onExpand={onExpand} onCopy={onCopy} onClear={onClear} onUndo={onUndo} onRedo={onRedo} canUndo={canUndo} canRedo={canRedo} disabled={disabled} />
          <FieldSection icon="üëã" title="ÂºÄÂú∫ÁôΩ" fieldKey="first_message" value={data.first_message} onChange={v => onChange('first_message', v)} onGenerate={() => onGen('first_message')} onExpand={onExpand} onCopy={onCopy} onClear={onClear} onUndo={onUndo} onRedo={onRedo} canUndo={canUndo} canRedo={canRedo} disabled={disabled} rows={6} />
          <FieldSection icon="üí¨" title="ÂØπËØùÁ§∫‰æã" fieldKey="message_example" value={data.message_example} onChange={v => onChange('message_example', v)} onGenerate={() => onGen('message_example')} onExpand={onExpand} onCopy={onCopy} onClear={onClear} onUndo={onUndo} onRedo={onRedo} canUndo={canUndo} canRedo={canRedo} disabled={disabled} rows={5} />
        </div>
      ));

      const AdvancedTab = memo(({ data, onChange, onGen, onExpand, onCopy, onClear, onUndo, onRedo, canUndo, canRedo, disabled }) => {
        const updateGreeting = (action, idx, val) => {
          const arr = [...(data.alternate_greetings || [])];
          if (action === 'add') arr.push('');
          else if (action === 'remove') arr.splice(idx, 1);
          else arr[idx] = val;
          onChange('alternate_greetings', arr);
        };

        return (
          <div>
            <FieldSection icon="ü§ñ" title="Á≥ªÁªüÊèêÁ§∫ËØç" fieldKey="system_prompt" value={data.system_prompt} onChange={v => onChange('system_prompt', v)} onGenerate={() => {}} onExpand={onExpand} onCopy={onCopy} onClear={onClear} onUndo={onUndo} onRedo={onRedo} canUndo={canUndo} canRedo={canRedo} disabled={true} rows={4} />
            <FieldSection icon="üìã" title="ÂéÜÂè≤ÂêéÊåá‰ª§" fieldKey="post_history_instructions" value={data.post_history_instructions} onChange={v => onChange('post_history_instructions', v)} onGenerate={() => {}} onExpand={onExpand} onCopy={onCopy} onClear={onClear} onUndo={onUndo} onRedo={onRedo} canUndo={canUndo} canRedo={canRedo} disabled={true} rows={3} />
            <FieldSection icon="‚úèÔ∏è" title="‰ΩúËÄÖÂ§áÊ≥®" fieldKey="creator_notes" value={data.creator_notes} onChange={v => onChange('creator_notes', v)} onGenerate={() => {}} onExpand={onExpand} onCopy={onCopy} onClear={onClear} onUndo={onUndo} onRedo={onRedo} canUndo={canUndo} canRedo={canRedo} disabled={true} rows={3} />
            <div className="section-card">
              <div className="section-header">
                <span className="section-title">üé≠ Â§áÈÄâÈóÆÂÄôËØ≠ ({(data.alternate_greetings || []).length})</span>
                <div className="section-tools">
                  <button className="btn-sm blush" onClick={() => onChange('alternate_greetings', [])}>üóëÔ∏è Ê∏ÖÁ©∫ÂÖ®ÈÉ®</button>
                  <button className="btn-sm sky" onClick={() => onGen('alternate_greetings')} disabled={disabled}>‚ú® ÁîüÊàê</button>
                </div>
              </div>
              {(data.alternate_greetings || []).map((g, i) => (
                <div key={i} style={{ display: 'flex', gap: 10, marginBottom: 10 }}>
                  <textarea className="textarea" style={{ flex: 1, minHeight: 60 }} value={g} onChange={e => updateGreeting('change', i, e.target.value)} />
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>
                    <button className="btn-sm mint" onClick={() => copyToClipboard(g)}>üìã</button>
                    <button className="btn-sm blush" onClick={() => updateGreeting('remove', i)}>√ó</button>
                  </div>
                </div>
              ))}
              <button className="btn primary" style={{ padding: '10px 20px' }} onClick={() => updateGreeting('add')}>‚ûï Ê∑ªÂä†</button>
            </div>
          </div>
        );
      });

      const WorldBookTab = memo(({ data, setData, disabled }) => {
        const [search, setSearch] = useState('');
        const [collapsed, setCollapsed] = useState({});
        
        const entries = data.book_entries || [];
        const filtered = entries.filter(e => !search || e.name?.toLowerCase().includes(search.toLowerCase()) || e.content?.toLowerCase().includes(search.toLowerCase()));
        
        const updateEntry = (idx, key, val) => {
          const arr = [...entries];
          arr[idx] = { ...arr[idx], [key]: val };
          setData(p => ({ ...p, book_entries: arr }));
        };
        const addEntry = () => setData(p => ({ ...p, book_entries: [...(p.book_entries || []), { name: 'Êñ∞Êù°ÁõÆ', keysText: '', content: '', enabled: true, insertion_order: 100, depth: 4 }] }));
        const removeEntry = (idx) => setData(p => ({ ...p, book_entries: entries.filter((_, i) => i !== idx) }));
        const clearAllEntries = () => setData(p => ({ ...p, book_entries: [] }));
        const toggleAll = () => {
          const allCollapsed = Object.keys(collapsed).length === entries.length && Object.values(collapsed).every(Boolean);
          setCollapsed(allCollapsed ? {} : Object.fromEntries(entries.map((_, i) => [i, true])));
        };

        return (
          <div>
            <div className="section-card">
              <div className="section-header"><span className="section-title">üìö ‰∏ñÁïå‰π¶‰ø°ÊÅØ</span></div>
              <input className="input" value={data.world_book_name || ''} onChange={e => setData(p => ({ ...p, world_book_name: e.target.value }))} placeholder="‰∏ñÁïå‰π¶ÂêçÁß∞" />
            </div>
            <div className="book-toolbar">
              <div className="search-box">
                <input placeholder="ÊêúÁ¥¢Êù°ÁõÆ..." value={search} onChange={e => setSearch(e.target.value)} />
              </div>
              <button className="btn secondary" style={{ padding: '10px 16px' }} onClick={toggleAll}>
                {Object.keys(collapsed).length === entries.length ? 'üìÇ Â±ïÂºÄÂÖ®ÈÉ®' : 'üìÅ ÊäòÂè†ÂÖ®ÈÉ®'}
              </button>
              <button className="btn secondary" style={{ padding: '10px 16px', background: 'var(--blush)', borderColor: 'var(--rose)', color: '#c9939c' }} onClick={clearAllEntries}>
                üóëÔ∏è Ê∏ÖÁ©∫ÂÖ®ÈÉ®
              </button>
              <button className="btn primary" style={{ padding: '10px 16px' }} onClick={addEntry}>‚ûï Ê∑ªÂä†Êù°ÁõÆ</button>
            </div>
            {filtered.map((entry, i) => {
              const realIdx = entries.indexOf(entry);
              return <BookEntry key={realIdx} entry={entry} index={realIdx} onChange={updateEntry} onRemove={removeEntry} collapsed={collapsed[realIdx]} onToggle={() => setCollapsed(p => ({ ...p, [realIdx]: !p[realIdx] }))} />;
            })}
            {filtered.length === 0 && <p style={{ textAlign: 'center', color: 'var(--text-soft)', padding: 30 }}>Ê≤°ÊúâÊâæÂà∞Êù°ÁõÆ</p>}
          </div>
        );
      });

      // Translation Modal
      const TranslateModal = memo(({ show, onClose, items, onApply, translating, progress }) => {
        const [selection, setSelection] = useState({});
        
        useEffect(() => {
          const sel = {};
          items.forEach((item, i) => { if (item.status === 'success') sel[i] = true; });
          setSelection(sel);
        }, [items]);

        if (!show) return null;

        const stats = items.reduce((acc, item) => {
          acc[item.status || 'pending']++;
          return acc;
        }, { success: 0, error: 0, pending: 0, translating: 0 });

        const handleApply = () => {
          onApply(items.map((item, i) => ({ ...item, selected: item.status === 'success' && selection[i] })));
        };

        return (
          <Modal show large title={translating ? 'üê± Ê≠£Âú®ÁøªËØëÂñµ~' : '‚ú® ÁøªËØëÂÆåÊàêÔºÅ'} onClose={onClose} canClose={!translating} footer={
            translating ? null : (
              <>
                <button className="btn success" onClick={handleApply} disabled={stats.success === 0}>Â∫îÁî®ÈÄâ‰∏≠ ({Object.values(selection).filter(Boolean).length})</button>
                <button className="btn secondary" onClick={onClose}>ÂèñÊ∂à</button>
              </>
            )
          }>
            <div className="compare-header">
              <div style={{ display: 'flex', alignItems: 'center', gap: 12, flex: 1 }}>
                <span>ËøõÂ∫¶</span>
                <div className="progress-bar"><div className="progress-fill" style={{ width: `${progress}%` }} /></div>
                <span>{Math.round(progress)}%</span>
              </div>
              <div className="stats">
                <span className="stat success">‚úì {stats.success}</span>
                <span className="stat error">‚úó {stats.error}</span>
                <span className="stat pending">‚ó∑ {stats.pending + stats.translating}</span>
              </div>
            </div>
            <div style={{ marginTop: 16 }}>
              {items.map((item, idx) => {
                const status = item.status || 'pending';
                let label = item.field.replace(/_/g, ' ');
                if (item.entryIndex != null) label = `Êù°ÁõÆ#${item.entryIndex + 1}: ${label}`;
                else if (item.index != null) label = `${label} #${item.index + 1}`;

                return (
                  <div key={idx} className={`compare-item ${status}`}>
                    <div className="compare-item-header">
                      <label>
                        <input type="checkbox" checked={!!selection[idx]} onChange={() => setSelection(p => ({ ...p, [idx]: !p[idx] }))} disabled={status !== 'success'} />
                        {label}
                      </label>
                      <span className={`status-badge ${status}`}>
                        {{ pending: 'Á≠âÂæÖ‰∏≠', translating: 'ÁøªËØë‰∏≠~', success: 'ÂÆåÊàê', error: 'Â§±Ë¥•' }[status]}
                      </span>
                    </div>
                    <div className="compare-grid">
                      <div className="compare-col original">
                        <h4>üìÑ ÂéüÊñá</h4>
                        <div className="compare-box">{item.original}</div>
                      </div>
                      <div className="compare-col translated">
                        <h4>üå∏ ËØëÊñá</h4>
                        <div className={`compare-box ${status === 'pending' ? 'pending' : ''}`}>
                          {status === 'pending' && 'Á≠âÂæÖÁøªËØë...'}
                          {status === 'translating' && 'Ê≠£Âú®ÁøªËØëÂñµ~'}
                          {status === 'success' && item.translated}
                          {status === 'error' && <span style={{ color: '#c9939c' }}>{item.error || 'ÁøªËØëÂ§±Ë¥•'}</span>}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </Modal>
        );
      });

      // Settings Modal
      const SettingsModal = memo(({ show, onClose, providers, providerIdx, onSave }) => {
        const [local, setLocal] = useState([]);
        const [idx, setIdx] = useState(0);
        const [editing, setEditing] = useState(null);

        useEffect(() => {
          if (show) {
            setLocal(JSON.parse(JSON.stringify(providers)));
            setIdx(providerIdx);
            setEditing(null);
          }
        }, [show, providers, providerIdx]);

        if (!show) return null;

        const handleSave = () => { onSave(local, idx); onClose(); };
        const handleEdit = (p) => setEditing(JSON.parse(JSON.stringify(p)));
        const handleDelete = (id) => {
          if (!confirm('Á°ÆÂÆöÂà†Èô§Ôºü')) return;
          const arr = local.filter(p => p.id !== id);
          setLocal(arr);
          if (idx >= arr.length) setIdx(Math.max(0, arr.length - 1));
        };
        const handleSaveProvider = () => {
          if (!editing.name || !editing.key) return alert('ËØ∑Â°´ÂÜôÂÆåÊï¥');
          if (!editing.id) {
            editing.id = Date.now();
            setLocal([...local, editing]);
          } else {
            setLocal(local.map(p => p.id === editing.id ? editing : p));
          }
          setEditing(null);
        };

        return (
          <Modal show onClose={onClose} title="‚öôÔ∏è API ËÆæÁΩÆ" footer={<button className="btn primary" onClick={handleSave}>Á°ÆËÆ§‰øùÂ≠ò</button>}>
            <div className="form-group">
              <label>ÂΩìÂâç‰ΩøÁî®</label>
              <select value={idx} onChange={e => setIdx(+e.target.value)}>
                {local.map((p, i) => <option key={p.id} value={i}>{p.name}</option>)}
              </select>
            </div>
            <hr style={{ border: 'none', borderTop: '2px dashed var(--cream-deep)', margin: '20px 0' }} />
            <h3 style={{ marginBottom: 16 }}>‰æõÂ∫îÂïÜÂàóË°®</h3>
            {local.map(p => (
              <div key={p.id} className="provider-item">
                <span className="name">{p.name}</span>
                <div className="btns">
                  <button className="btn-sm sky" onClick={() => handleEdit(p)}>ÁºñËæë</button>
                  <button className="btn-sm blush" onClick={() => handleDelete(p.id)}>Âà†Èô§</button>
                </div>
              </div>
            ))}
            <button className="btn secondary" style={{ marginTop: 10, width: '100%' }} onClick={() => handleEdit({ name: '', url: '', key: '', models: 'gemini-1.5-flash-latest', supportsVision: true })}>
              ‚ûï Ê∑ªÂä†‰æõÂ∫îÂïÜ
            </button>
            {editing && (
              <>
                <hr style={{ border: 'none', borderTop: '2px dashed var(--cream-deep)', margin: '20px 0' }} />
                <h3>{editing.id ? 'ÁºñËæë' : 'Ê∑ªÂä†'}‰æõÂ∫îÂïÜ</h3>
                <div className="form-group"><label>ÂêçÁß∞</label><input value={editing.name} onChange={e => setEditing({ ...editing, name: e.target.value })} /></div>
                <div className="form-group"><label>APIÂú∞ÂùÄ (GeminiÁïôÁ©∫)</label><input value={editing.url || ''} onChange={e => setEditing({ ...editing, url: e.target.value })} placeholder="https://api.openai.com/v1" /></div>
                <div className="form-group"><label>API Key</label><input type="password" value={editing.key} onChange={e => setEditing({ ...editing, key: e.target.value })} /></div>
                <div className="form-group"><label>Ê®°ÂûãÂêçÁß∞</label><input value={editing.models || ''} onChange={e => setEditing({ ...editing, models: e.target.value })} /></div>
                <label className="checkbox-item" style={{ marginBottom: 16 }}>
                  <input type="checkbox" checked={!!editing.supportsVision} onChange={e => setEditing({ ...editing, supportsVision: e.target.checked })} />
                  <span>ÊîØÊåÅÂõæÂÉèËØÜÂà´</span>
                </label>
                <div style={{ display: 'flex', gap: 10 }}>
                  <button className="btn primary" onClick={handleSaveProvider}>‰øùÂ≠ò</button>
                  <button className="btn secondary" onClick={() => setEditing(null)}>ÂèñÊ∂à</button>
                </div>
              </>
            )}
          </Modal>
        );
      });

      // Prompt Modal with Templates
      const PromptModal = memo(({ show, onClose, config, onSave }) => {
        const [prompt, setPrompt] = useState('');
        const [templates, setTemplates] = useLocalStorage(TEMPLATES_KEY, []);
        const [newName, setNewName] = useState('');
        
        useEffect(() => { if (show) setPrompt(config?.systemPrompt || ''); }, [show, config]);
        if (!show) return null;

        const saveTemplate = () => {
          if (!newName.trim()) return;
          setTemplates([...templates, { name: newName.trim(), prompt }]);
          setNewName('');
        };
        
        const loadTemplate = (t) => setPrompt(t.prompt);
        const deleteTemplate = (name) => setTemplates(templates.filter(t => t.name !== name));

        return (
          <Modal show onClose={onClose} title="üìù ÁøªËØëÊèêÁ§∫ËØç" footer={
            <>
              <button className="btn primary" onClick={() => { onSave({ ...config, systemPrompt: prompt }); onClose(); }}>‰øùÂ≠ò</button>
              <button className="btn secondary" onClick={onClose}>ÂèñÊ∂à</button>
            </>
          }>
            <div className="form-group">
              <label>Á≥ªÁªüÊèêÁ§∫ËØç</label>
              <textarea value={prompt} onChange={e => setPrompt(e.target.value)} style={{ minHeight: 150 }} />
            </div>
            
            <div className="template-section">
              <div className="template-header">
                <h4>üìÅ Ê®°ÊùøÁÆ°ÁêÜ</h4>
              </div>
              <div style={{ display: 'flex', gap: 8, marginBottom: 12 }}>
                <input className="input" style={{ flex: 1, padding: '10px 14px' }} placeholder="Ê®°ÊùøÂêçÁß∞" value={newName} onChange={e => setNewName(e.target.value)} />
                <button className="btn primary" style={{ padding: '10px 20px' }} onClick={saveTemplate} disabled={!newName.trim()}>üíæ ‰øùÂ≠òÂΩìÂâç</button>
              </div>
              {templates.length === 0 ? (
                <p style={{ color: 'var(--text-soft)', fontSize: 13, textAlign: 'center', padding: 16 }}>ÊöÇÊó†Ê®°ÊùøÔºå‰øùÂ≠òÂΩìÂâçÊèêÁ§∫ËØç‰Ωú‰∏∫Ê®°Êùø</p>
              ) : (
                templates.map(t => (
                  <div key={t.name} className="template-item">
                    <span className="name" onClick={() => loadTemplate(t)}>{t.name}</span>
                    <div className="btns">
                      <button className="btn-sm sky" onClick={() => loadTemplate(t)}>Âä†ËΩΩ</button>
                      <button className="btn-sm blush" onClick={() => deleteTemplate(t.name)}>Âà†Èô§</button>
                    </div>
                  </div>
                ))
              )}
            </div>
          </Modal>
        );
      });

      const BatchModal = memo(({ show, onClose, onStart, title, fields }) => {
        const [sel, setSel] = useState({});
        useEffect(() => { if (show) setSel(Object.fromEntries(Object.keys(fields).map(k => [k, true]))); }, [show, fields]);
        if (!show) return null;

        return (
          <Modal show onClose={onClose} title={title} footer={
            <>
              <button className="btn primary" onClick={() => onStart(sel)} disabled={!Object.values(sel).some(Boolean)}>ÂºÄÂßãÁøªËØë</button>
              <button className="btn secondary" onClick={onClose}>ÂèñÊ∂à</button>
            </>
          }>
            <p style={{ marginBottom: 16, color: 'var(--text-soft)' }}>ÈÄâÊã©Ë¶ÅÁøªËØëÁöÑÂ≠óÊÆµÔºö</p>
            {Object.keys(fields).map(field => (
              <label key={field} className="checkbox-item">
                <input type="checkbox" checked={!!sel[field]} onChange={() => setSel(p => ({ ...p, [field]: !p[field] }))} />
                <span>{field.replace(/_/g, ' ')}</span>
              </label>
            ))}
          </Modal>
        );
      });

      const ReplaceModal = memo(({ show, onClose, onReplace, data }) => {
        const [find, setFind] = useState('');
        const [replace, setReplace] = useState('');

        const count = useMemo(() => {
          if (!find || !data) return 0;
          let c = 0;
          const cnt = s => (s?.split(find).length - 1) || 0;
          ['name', 'description', 'personality', 'scenario', 'first_message', 'message_example'].forEach(f => c += cnt(data[f]));
          data.book_entries?.forEach(e => { c += cnt(e.name) + cnt(e.content); });
          return c;
        }, [find, data]);

        useEffect(() => { if (!show) { setFind(''); setReplace(''); } }, [show]);

        return (
          <Modal show={show} onClose={onClose} title="üîÅ ÂÖ®Â±ÄÊõøÊç¢" footer={
            <>
              <button className="btn primary" onClick={() => { onReplace(find, replace); }} disabled={!find || count === 0}>ÊõøÊç¢ ({count}Â§Ñ)</button>
              <button className="btn secondary" onClick={onClose}>ÂèñÊ∂à</button>
            </>
          }>
            <div className="form-group"><label>Êü•Êâæ</label><input value={find} onChange={e => setFind(e.target.value)} placeholder="Ë¶ÅÊõøÊç¢ÁöÑÊñáÊú¨" /></div>
            <div className="form-group"><label>ÊõøÊç¢‰∏∫</label><input value={replace} onChange={e => setReplace(e.target.value)} placeholder="ÊõøÊç¢ÂêéÁöÑÊñáÊú¨" /></div>
          </Modal>
        );
      });

      // ================== Main App ==================
      const App = () => {
        const { toasts, addToast } = useToast();
        const { theme, toggle: toggleTheme } = useTheme();
        const { history, addToHistory, removeFromHistory } = useHistory();
        
        const [fileName, setFileName] = useState('');
        const [imageSrc, setImageSrc] = useState('');
        const [genImage, setGenImage] = useState(null);
        const [charData, setCharData] = useState(null);
        const [loading, setLoading] = useState('');
        const [error, setError] = useState('');
        const [tab, setTab] = useState('basic');
        const [isDragOver, setDragOver] = useState(false);
        const [lastSave, setLastSave] = useState(null);

        // Undo/Redo
        const { state: data, set: setData, undo, redo, canUndo, canRedo, reset: resetData } = useUndo(null);

        // Translation
        const [compareItems, setCompareItems] = useState([]);
        const [translating, setTranslating] = useState(false);
        const [progress, setProgress] = useState(0);

        // Modals
        const [modals, setModals] = useState({ settings: false, prompt: false, batch: false, advanced: false, worldbook: false, compare: false, replace: false, clearAll: false, export: false });
        
        // Full Editor
        const [fullEditor, setFullEditor] = useState({ show: false, field: '', title: '' });

        // Config
        const [providers, setProviders] = useLocalStorage('providers', [{ id: 1, name: 'Google Gemini', url: '', key: '', models: 'gemini-1.5-flash-latest', supportsVision: true }]);
        const [providerIdx, setProviderIdx] = useLocalStorage('providerIdx', 0);
        const [model, setModel] = useState('');
        const [config, setConfig] = useLocalStorage('translateConfig', { systemPrompt: 'ËØ∑ÁøªËØëÊàêÁÆÄ‰Ωì‰∏≠ÊñáÔºå‰øùÊåÅÂéüÊúâÁöÑËØ≠Ê∞îÂíåÈ£éÊ†º„ÄÇ' });

        const imgRef = useRef();
        const fileRef = useRef();

        useEffect(() => {
          const p = providers[providerIdx];
          if (p?.models) setModel(p.models.split(',')[0]?.trim() || '');
        }, [providerIdx, providers]);

        // Auto save
        useEffect(() => {
          if (!data) return;
          const timer = setTimeout(() => {
            try {
              localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify({ data, charData, fileName, imgSrc: imageSrc }));
              setLastSave(new Date());
            } catch {}
          }, 2000);
          return () => clearTimeout(timer);
        }, [data, charData, fileName, imageSrc]);

        // Load auto save on mount
        useEffect(() => {
          try {
            const saved = localStorage.getItem(AUTO_SAVE_KEY);
            if (saved) {
              const { data: d, charData: c, fileName: f, imgSrc: i } = JSON.parse(saved);
              if (d && confirm('ÂèëÁé∞Êú™‰øùÂ≠òÁöÑÊï∞ÊçÆÔºåÊòØÂê¶ÊÅ¢Â§çÔºü')) {
                resetData(d); setCharData(c); setFileName(f); setImageSrc(i);
                addToast('Â∑≤ÊÅ¢Â§ç‰∏äÊ¨°ÁºñËæë', 'success');
              }
            }
          } catch {}
        }, []);

        const reset = useCallback(() => {
          setFileName(''); setImageSrc(''); setGenImage(null); setCharData(null); resetData(null); setError(''); setLoading(''); setLastSave(null);
          localStorage.removeItem(AUTO_SAVE_KEY);
        }, [resetData]);

        const clearAllContent = useCallback(() => {
          setData({
            ...data,
            name: '',
            description: '',
            personality: '',
            scenario: '',
            first_message: '',
            message_example: '',
            tags: [],
            alternate_greetings: [],
            book_entries: [],
            system_prompt: '',
            post_history_instructions: '',
            creator_notes: '',
            world_book_name: ''
          });
          setModals(m => ({ ...m, clearAll: false }));
          addToast('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπ', 'success');
        }, [data, setData, addToast]);

        const parseCharacterData = (json) => {
          const d = JSON.parse(JSON.stringify(json.data || json));
          d.first_message = d.first_mes || d.first_message || '';
          d.message_example = d.mes_example || d.message_example || '';
          d.alternate_greetings = d.alternate_greetings || [];
          d.tags = d.tags || [];
          const book = d.character_book || {};
          d.book_entries = (book.entries || []).map((e, i) => ({
            ...e,
            keysText: Array.isArray(e.keys) ? e.keys.join(', ') : '',
            secondaryKeysText: Array.isArray(e.secondary_keys) ? e.secondary_keys.join(', ') : '',
            name: e.comment || e.name || `Êù°ÁõÆ${i + 1}`,
          }));
          d.world_book_name = book.name || '';
          return d;
        };

        const processFile = useCallback(async (file) => {
          reset();
          setFileName(file.name);
          setLoading('Ê≠£Âú®Ëß£ÊûêÂñµ~');

          try {
            // Check if JSON
            if (file.type === 'application/json' || file.name.endsWith('.json')) {
              const text = await file.text();
              const json = JSON.parse(text);
              setCharData(json);
              const d = parseCharacterData(json);
              resetData(d);
              addToHistory({ name: d.name || file.name, type: 'json' });
              addToast('JSONÂä†ËΩΩÊàêÂäüÂñµÔºÅ', 'success');
              setLoading('');
              return;
            }

            // PNG processing
            setImageSrc(URL.createObjectURL(file));
            const bytes = new Uint8Array(await file.arrayBuffer());
            if (!isValidPNG(bytes)) throw new Error('Ëøô‰∏çÊòØÊúâÊïàÁöÑPNGÊñá‰ª∂Âñµ~');

            const extract = (keyword) => {
              let off = 8;
              while (off < bytes.length) {
                const len = new DataView(bytes.buffer).getUint32(off);
                const type = new TextDecoder().decode(bytes.slice(off + 4, off + 8));
                if (type === 'tEXt') {
                  const d = bytes.slice(off + 8, off + 8 + len);
                  const ni = d.indexOf(0);
                  if (ni !== -1 && new TextDecoder().decode(d.slice(0, ni)) === keyword)
                    return new TextDecoder().decode(d.slice(ni + 1));
                }
                if (type === 'IEND') break;
                off += 12 + len;
              }
              return null;
            };

            const raw = extract('ccv3') || extract('chara');
            if (!raw) throw new Error('Ê≤°ÊâæÂà∞ËßíËâ≤Âç°Êï∞ÊçÆÂñµ~');

            const json = JSON.parse(decodeBase64(raw));
            setCharData(json);
            const d = parseCharacterData(json);
            resetData(d);

            const reader = new FileReader();
            reader.onloadend = () => setGenImage({ mimeType: file.type, data: reader.result.split(',')[1] });
            reader.readAsDataURL(file);

            // Add to history
            addToHistory({ name: d.name || file.name, type: 'png', thumb: URL.createObjectURL(file) });
            addToast('Âä†ËΩΩÊàêÂäüÂñµÔºÅ', 'success');
          } catch (err) {
            setError(err.message);
            addToast(err.message, 'error');
          } finally {
            setLoading('');
          }
        }, [reset, resetData, addToast, addToHistory]);

        const handleFile = useCallback(e => { const f = e.target.files[0]; if (f) processFile(f); }, [processFile]);
        const handleDrop = useCallback(e => { 
          e.preventDefault(); 
          setDragOver(false); 
          const f = e.dataTransfer.files[0]; 
          if (f?.type === 'image/png' || f?.type === 'application/json' || f?.name?.endsWith('.json')) {
            processFile(f);
          } else {
            addToast('ËØ∑ÊãñÂÖ•PNGÊàñJSONÊñá‰ª∂Âñµ~', 'warning');
          }
        }, [processFile, addToast]);

        const createNew = useCallback(() => {
          reset();
          setCharData({ spec: 'chara_card_v3', spec_version: '3.0' });
          resetData({ name: '', description: '', personality: '', scenario: '', first_message: '', message_example: '', tags: [], alternate_greetings: [], book_entries: [], system_prompt: '', post_history_instructions: '', creator_notes: '', world_book_name: '' });
        }, [reset, resetData]);

        const updateField = useCallback((key, val) => setData(p => ({ ...p, [key]: val })), [setData]);

        const handleImageUpload = useCallback(e => {
          const f = e.target.files[0];
          if (f) {
            setImageSrc(URL.createObjectURL(f));
            const reader = new FileReader();
            reader.onloadend = () => setGenImage({ mimeType: f.type, data: reader.result.split(',')[1] });
            reader.readAsDataURL(f);
          }
        }, []);

        const handleExpand = useCallback((field, title) => {
          setFullEditor({ show: true, field, title });
        }, []);

        const handleCopy = useCallback((success) => {
          if (success) addToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
          else addToast('Â§çÂà∂Â§±Ë¥•', 'error');
        }, [addToast]);

        const handleClearField = useCallback((field) => {
          updateField(field, '');
          addToast('Â∑≤Ê∏ÖÁ©∫', 'success');
        }, [updateField, addToast]);

        const exportAsPNG = useCallback(async () => {
          if (!data || !imageSrc) { addToast('ËØ∑Á°Æ‰øùÊúâÊï∞ÊçÆÂíåÂ∞ÅÈù¢ÂõæÁâáÂñµ~', 'warning'); return false; }
          
          try {
            const bytes = await new Promise((resolve, reject) => {
              const img = new Image();
              img.crossOrigin = 'Anonymous';
              img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
                resolve(Uint8Array.from(atob(canvas.toDataURL('image/png').split(',')[1]), c => c.charCodeAt(0)));
              };
              img.onerror = () => reject(new Error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•'));
              img.src = imageSrc;
            });

            const exportData = { ...data };
            if (data.first_message) exportData.first_mes = data.first_message;
            if (data.message_example) exportData.mes_example = data.message_example;
            if (data.book_entries?.length) {
              exportData.character_book = {
                name: data.world_book_name || '',
                entries: data.book_entries.map(e => ({ ...e, comment: e.name, keys: (e.keysText || '').split(',').map(k => k.trim()).filter(Boolean) }))
              };
            }

            const v2 = encodeBase64(JSON.stringify({ spec: 'chara_card_v2', data: exportData }));
            const v3 = encodeBase64(JSON.stringify({ spec: 'chara_card_v3', spec_version: '3.0', data: exportData }));

            const iend = bytes.length - 12;
            const c1 = createTextChunk('chara', v2);
            const c2 = createTextChunk('ccv3', v3);
            const out = new Uint8Array(bytes.length + c1.length + c2.length);
            out.set(bytes.slice(0, iend));
            out.set(c1, iend);
            out.set(c2, iend + c1.length);
            out.set(bytes.slice(iend), iend + c1.length + c2.length);

            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([out], { type: 'image/png' }));
            a.download = `${data.name || 'character'}_export.png`;
            a.click();
            return true;
          } catch (err) {
            addToast(err.message, 'error');
            return false;
          }
        }, [data, imageSrc, addToast]);

        const exportAsJSON = useCallback(() => {
          if (!data) return false;
          const jsonStr = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonStr], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${data.name || 'character'}_data.json`;
          a.click();
          return true;
        }, [data]);

        const handleExport = useCallback(async (type) => {
          setModals(m => ({ ...m, export: false }));
          setLoading('Ê≠£Âú®ÂØºÂá∫Âñµ~');

          try {
            if (type === 'png') {
              await exportAsPNG();
              addToast('PNGÂØºÂá∫ÊàêÂäüÂñµÔºÅ', 'success');
            } else if (type === 'json') {
              exportAsJSON();
              addToast('JSONÂØºÂá∫ÊàêÂäüÂñµÔºÅ', 'success');
            } else if (type === 'both') {
              await exportAsPNG();
              exportAsJSON();
              addToast('ÂØºÂá∫ÊàêÂäüÂñµÔºÅ', 'success');
            }
            localStorage.removeItem(AUTO_SAVE_KEY);
          } catch (err) {
            addToast(err.message, 'error');
          } finally {
            setLoading('');
          }
        }, [exportAsPNG, exportAsJSON, addToast]);

        // Translation
        const startTranslation = useCallback(async (items) => {
          if (!providers[providerIdx]?.key) { addToast('ËØ∑ÂÖàÈÖçÁΩÆAPIÂñµ~', 'warning'); return; }
          if (!items.length) { addToast('Ê≤°ÊúâÈúÄË¶ÅÁøªËØëÁöÑÂÜÖÂÆπÂñµ~', 'warning'); return; }

          setCompareItems(items.map(i => ({ ...i, status: 'pending', translated: '' })));
          setModals(m => ({ ...m, compare: true }));
          setTranslating(true);
          setProgress(0);

          const chunks = Math.ceil(items.length / CHUNK_SIZE);

          for (let c = 0; c < chunks; c++) {
            const start = c * CHUNK_SIZE;
            const chunk = items.slice(start, start + CHUNK_SIZE);

            setCompareItems(p => p.map((item, i) => i >= start && i < start + chunk.length ? { ...item, status: 'translating' } : item));

            const tagMap = {};
            let prompt = '';
            chunk.forEach((item, i) => {
              tagMap[`T${i}`] = start + i;
              prompt += `<T${i}>${item.original}</T${i}>\n\n`;
            });

            try {
              const result = await callAPI([`ËØ∑ÁøªËØëÊàêÁÆÄ‰Ωì‰∏≠ÊñáÔºå‰øùÊåÅXMLÊ†áÁ≠æ‰∏çÂèòÔºö\n\n${prompt}`], config.systemPrompt, { providers, providerIdx, model });

              const regex = /<T(\d+)>([\s\S]*?)<\/T\1>/g;
              const translated = new Map();
              let match;
              while ((match = regex.exec(result)) !== null) {
                const idx = tagMap[`T${match[1]}`];
                if (idx !== undefined) translated.set(idx, match[2].trim());
              }

              setCompareItems(p => p.map((item, i) => {
                if (i >= start && i < start + chunk.length) {
                  return translated.has(i) ? { ...item, status: 'success', translated: translated.get(i) } : { ...item, status: 'error', error: 'ÁøªËØëÁº∫Â§±' };
                }
                return item;
              }));
            } catch (err) {
              setCompareItems(p => p.map((item, i) => i >= start && i < start + chunk.length ? { ...item, status: 'error', error: err.message } : item));
            }

            setProgress(((c + 1) / chunks) * 100);
          }

          setTranslating(false);
          addToast('ÁøªËØëÂÆåÊàêÂñµÔºÅ', 'success');
        }, [providers, providerIdx, model, config, addToast]);

        const handleTranslateAll = useCallback(() => {
          if (!data) return;
          const items = [];
          const add = (field, val, opts = {}) => { if (val?.trim()) items.push({ field, original: val.trim(), ...opts }); };
          add('name', data.name);
          add('description', data.description);
          add('personality', data.personality);
          add('scenario', data.scenario);
          add('first_message', data.first_message);
          add('message_example', data.message_example);
          data.tags?.forEach((t, i) => add('tags', t, { index: i }));
          data.alternate_greetings?.forEach((g, i) => add('alternate_greetings', g, { index: i }));
          data.book_entries?.forEach((e, i) => {
            add('name', e.name, { entryIndex: i });
            add('content', e.content, { entryIndex: i });
          });
          startTranslation(items);
        }, [data, startTranslation]);

        const handleBatchStart = useCallback((fields, type) => {
          setModals(m => ({ ...m, batch: false, advanced: false, worldbook: false }));
          const items = [];
          const add = (f, v, opts = {}) => { if (v?.trim()) items.push({ field: f, original: v.trim(), ...opts }); };
          
          if (type === 'basic') {
            if (fields.name) add('name', data?.name);
            if (fields.description) add('description', data?.description);
            if (fields.personality) add('personality', data?.personality);
            if (fields.scenario) add('scenario', data?.scenario);
            if (fields.first_message) add('first_message', data?.first_message);
            if (fields.message_example) add('message_example', data?.message_example);
            if (fields.tags) data?.tags?.forEach((t, i) => add('tags', t, { index: i }));
          } else if (type === 'advanced') {
            if (fields.system_prompt) add('system_prompt', data?.system_prompt);
            if (fields.post_history_instructions) add('post_history_instructions', data?.post_history_instructions);
            if (fields.creator_notes) add('creator_notes', data?.creator_notes);
            if (fields.alternate_greetings) data?.alternate_greetings?.forEach((g, i) => add('alternate_greetings', g, { index: i }));
          } else {
            Object.entries(fields).forEach(([name, checked]) => {
              if (checked) {
                const idx = data?.book_entries?.findIndex(e => e.name === name);
                if (idx >= 0) {
                  const e = data.book_entries[idx];
                  add('name', e.name, { entryIndex: idx });
                  add('content', e.content, { entryIndex: idx });
                }
              }
            });
          }
          startTranslation(items);
        }, [data, startTranslation]);

        const applyTranslation = useCallback((items) => {
          setData(p => {
            const d = { ...p };
            const entries = JSON.parse(JSON.stringify(d.book_entries || []));
            const greetings = [...(d.alternate_greetings || [])];
            const tags = [...(d.tags || [])];

            items.forEach(item => {
              if (!item.selected || item.status !== 'success') return;
              if (item.entryIndex != null && entries[item.entryIndex]) {
                entries[item.entryIndex][item.field] = item.translated;
              } else if (item.field === 'alternate_greetings' && item.index != null) {
                greetings[item.index] = item.translated;
              } else if (item.field === 'tags' && item.index != null) {
                tags[item.index] = item.translated;
              } else if (item.index == null && item.entryIndex == null) {
                d[item.field] = item.translated;
              }
            });

            d.book_entries = entries;
            d.alternate_greetings = greetings;
            d.tags = tags;
            return d;
          });
          setModals(m => ({ ...m, compare: false }));
          addToast('Â∑≤Â∫îÁî®ÁøªËØëÂñµÔºÅ', 'success');
        }, [setData, addToast]);

        const handleReplace = useCallback((find, replace) => {
          if (!find || !data) return;
          const rep = s => s?.replaceAll(find, replace) || s;
          const d = JSON.parse(JSON.stringify(data));
          ['name', 'description', 'personality', 'scenario', 'first_message', 'message_example', 'system_prompt', 'post_history_instructions', 'creator_notes'].forEach(f => d[f] = rep(d[f]));
          d.tags = d.tags?.map(rep);
          d.alternate_greetings = d.alternate_greetings?.map(rep);
          d.book_entries = d.book_entries?.map(e => ({ ...e, name: rep(e.name), content: rep(e.content), keysText: rep(e.keysText) }));
          setData(d);
          setModals(m => ({ ...m, replace: false }));
          addToast('ÊõøÊç¢ÂÆåÊàêÂñµÔºÅ', 'success');
        }, [data, setData, addToast]);

        const handleGenerate = useCallback(async (field) => {
          if (!genImage || !providers[providerIdx]?.key) { addToast('ËØ∑Á°Æ‰øùÊúâÂõæÁâáÂíåAPIÈÖçÁΩÆÂñµ~', 'warning'); return; }
          setLoading(`ÁîüÊàê${field}‰∏≠...`);
          try {
            const result = await callAPI([DEFAULT_PROMPTS[field] || `‰∏∫ËßíËâ≤ÁîüÊàê${field}`, { inlineData: genImage }], '‰Ω†ÊòØ‰∏Ä‰∏™ÂèØÁà±ÁöÑËßíËâ≤ËÆæËÆ°Âä©Êâã', { providers, providerIdx, model });
            if (field === 'tags') updateField('tags', result.split(/[,Ôºå]/g).map(t => t.trim()).filter(Boolean));
            else if (field === 'alternate_greetings') updateField('alternate_greetings', result.split('|||').map(g => g.trim()).filter(Boolean));
            else updateField(field, result.trim());
            addToast('ÁîüÊàêÊàêÂäüÂñµÔºÅ', 'success');
          } catch (err) { addToast(err.message, 'error'); }
          finally { setLoading(''); }
        }, [genImage, providers, providerIdx, model, updateField, addToast]);

        const saveProviders = useCallback((p, i) => { setProviders(p); setProviderIdx(i); }, []);

        return (
          <>
            <div className="container">
              <header className="header">
                <div className="header-title">
                  <span className="cat-icon">üê±</span>
                  <span>ÂñµÂñµËßíËâ≤Âç°Â∑•Âùä</span>
                </div>
                <div className="header-actions">
                  <div className="header-select">
                    <span>ü§ñ</span>
                    <select value={model} onChange={e => setModel(e.target.value)}>
                      {(providers[providerIdx]?.models || '').split(',').map(m => m.trim()).filter(Boolean).map(m => <option key={m} value={m}>{m}</option>)}
                    </select>
                  </div>
                  <button className="header-btn" onClick={handleTranslateAll} disabled={loading || translating || !data}>üå∏ ‰∏ÄÈîÆÁøªËØë</button>
                  <button className="header-btn" onClick={() => setModals(m => ({ ...m, replace: true }))} disabled={!data}>üîÅ ÊõøÊç¢</button>
                  <button className="header-btn" onClick={() => setModals(m => ({ ...m, prompt: true }))}>üìù ÊèêÁ§∫ËØç</button>
                  <button className="header-btn" onClick={() => setModals(m => ({ ...m, settings: true }))}>‚öôÔ∏è API</button>
                  <button className="header-btn" onClick={toggleTheme}>{theme === 'light' ? 'üåô ÊöóËâ≤' : '‚òÄÔ∏è ‰∫ÆËâ≤'}</button>
                </div>
              </header>

              {!data ? (
                <div className={`upload-area ${isDragOver ? 'drag-over' : ''}`} onDragOver={e => { e.preventDefault(); setDragOver(true); }} onDragLeave={() => setDragOver(false)} onDrop={handleDrop}>
                  <div className="upload-icon">üì¶</div>
                  <p className="upload-text">ÊãñÊãΩ PNG/JSON ËßíËâ≤Âç°Âà∞ËøôÈáåÔºåÊàñÁÇπÂáª‰∏ãÊñπÊåâÈíÆ</p>
                  <div className="upload-buttons">
                    <label className="btn primary">üìÇ ÊâìÂºÄËßíËâ≤Âç°<input ref={fileRef} type="file" accept="image/png,.json,application/json" className="hidden" onChange={handleFile} /></label>
                    <button className="btn secondary" onClick={createNew}>‚ú® ÂàõÂª∫Êñ∞ËßíËâ≤</button>
                  </div>
                  <p className="upload-hint">ÊîØÊåÅ PNG ÂõæÁâáËßíËâ≤Âç°Âíå JSON Êï∞ÊçÆÊñá‰ª∂</p>
                  
                  {history.length > 0 && (
                    <div className="history-section">
                      <div className="history-title">üìú ÊúÄËøëÊâìÂºÄ</div>
                      <div className="history-list">
                        {history.map(h => (
                          <div key={h.name + h.date} className="history-item" onClick={() => addToast('ËØ∑ÈáçÊñ∞ÊâìÂºÄÊñá‰ª∂', 'info')}>
                            {h.thumb ? <img src={h.thumb} alt="" /> : <div className="placeholder">üìÑ</div>}
                            <div className="info">
                              <div className="name">{h.name || 'Êú™ÂëΩÂêç'}</div>
                              <div className="date">{formatDate(h.date)}</div>
                            </div>
                            <button className="delete" onClick={(e) => { e.stopPropagation(); removeFromHistory(h.name); }}>√ó</button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <>
                  <div className="file-bar">
                    <span className="file-icon">üê±</span>
                    <span className="file-name">{fileName || 'Êñ∞ËßíËâ≤'}</span>
                    {lastSave && <span className="auto-save">‚úì Â∑≤Ëá™Âä®‰øùÂ≠ò</span>}
                    <button className="close-btn" onClick={reset}>‚úï ÂÖ≥Èó≠</button>
                  </div>

                  {error && <div className="error" style={{ marginBottom: 20, padding: 20, background: 'var(--blush)', borderRadius: 'var(--radius-md)', color: '#c9939c' }}>{error}</div>}

                  <div className="main-card">
                    <div className="char-info">
                      <div className="char-avatar">
                        <div className="char-avatar-box" onClick={() => imgRef.current?.click()}>
                          {imageSrc ? <img src={imageSrc} alt="Avatar" /> : <><span className="placeholder-icon">üì∑</span><span>ÁÇπÂáª‰∏ä‰º†Â∞ÅÈù¢</span></>}
                        </div>
                        <input ref={imgRef} type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                      </div>
                      <div className="char-details">
                        <div className="spec-badge">‚ú® {charData?.spec || 'V3'}</div>
                        <div className="field-group">
                          <div className="field-label">
                            <span>üè∑Ô∏è ËßíËâ≤ÂêçÁß∞</span>
                            <div className="actions">
                              <button className="btn-sm mint" onClick={() => copyToClipboard(data.name).then(s => handleCopy(s))}>üìã</button>
                              <button className="btn-sm sky" onClick={() => handleGenerate('name')} disabled={loading || !genImage}>‚ú® ÁîüÊàê</button>
                            </div>
                          </div>
                          <input className="input" value={data.name || ''} onChange={e => updateField('name', e.target.value)} placeholder="ËæìÂÖ•ËßíËâ≤ÂêçÁß∞..." />
                        </div>
                        <div className="field-group">
                          <div className="field-label">
                            <span>üéÄ Ê†áÁ≠æ</span>
                            <div className="actions">
                              <button className="btn-sm mint" onClick={() => copyToClipboard(data.tags?.join(', ')).then(s => handleCopy(s))}>üìã</button>
                              <button className="btn-sm sky" onClick={() => handleGenerate('tags')} disabled={loading || !genImage}>‚ú® ÁîüÊàê</button>
                            </div>
                          </div>
                          <input className="input" style={{ fontSize: 14 }} value={Array.isArray(data.tags) ? data.tags.join(', ') : ''} onChange={e => updateField('tags', e.target.value.split(/[,Ôºå]/g).map(t => t.trim()).filter(Boolean))} placeholder="Ê†áÁ≠æ1, Ê†áÁ≠æ2, Ê†áÁ≠æ3" />
                        </div>
                      </div>
                    </div>

                    <div className="tabs">
                      <button className={`tab-btn ${tab === 'basic' ? 'active' : ''}`} onClick={() => setTab('basic')}>üìã Âü∫Êú¨‰ø°ÊÅØ</button>
                      <button className={`tab-btn ${tab === 'advanced' ? 'active' : ''}`} onClick={() => setTab('advanced')}>‚öôÔ∏è È´òÁ∫ßËÆæÁΩÆ</button>
                      <button className={`tab-btn ${tab === 'book' ? 'active' : ''}`} onClick={() => setTab('book')}>
                        üìö ‰∏ñÁïå‰π¶
                        <span className="badge">{data.book_entries?.length || 0}</span>
                      </button>
                      <div className="tabs-spacer" />
                      <button className="clear-all-btn" onClick={() => setModals(m => ({ ...m, clearAll: true }))}>üóëÔ∏è ‰∏ÄÈîÆÊ∏ÖÁ©∫</button>
                    </div>

                    <div className="tab-content">
                      <div className="batch-actions">
                        {tab === 'basic' && <button className="btn primary" onClick={() => setModals(m => ({ ...m, batch: true }))}>üå∏ ÊâπÈáèÁøªËØë</button>}
                        {tab === 'advanced' && <button className="btn primary" onClick={() => setModals(m => ({ ...m, advanced: true }))}>üå∏ ÊâπÈáèÁøªËØë</button>}
                        {tab === 'book' && <button className="btn primary" onClick={() => setModals(m => ({ ...m, worldbook: true }))}>üå∏ ÊâπÈáèÁøªËØë</button>}
                      </div>

                      {tab === 'basic' && <BasicTab data={data} onChange={updateField} onGen={handleGenerate} onExpand={handleExpand} onCopy={handleCopy} onClear={handleClearField} onUndo={undo} onRedo={redo} canUndo={canUndo} canRedo={canRedo} disabled={loading || !genImage} />}
                      {tab === 'advanced' && <AdvancedTab data={data} onChange={updateField} onGen={handleGenerate} onExpand={handleExpand} onCopy={handleCopy} onClear={handleClearField} onUndo={undo} onRedo={redo} canUndo={canUndo} canRedo={canRedo} disabled={loading || !genImage} />}
                      {tab === 'book' && <WorldBookTab data={data} setData={setData} disabled={loading} />}
                    </div>

                    <div className="export-section">
                      <button className="export-btn" onClick={() => setModals(m => ({ ...m, export: true }))} disabled={loading}>üíæ ÂØºÂá∫ËßíËâ≤Âç°</button>
                    </div>
                  </div>
                </>
              )}
            </div>

            {loading && <LoadingOverlay message={loading} />}
            <Toast toasts={toasts} />

            <SettingsModal show={modals.settings} onClose={() => setModals(m => ({ ...m, settings: false }))} providers={providers} providerIdx={providerIdx} onSave={saveProviders} />
            <PromptModal show={modals.prompt} onClose={() => setModals(m => ({ ...m, prompt: false }))} config={config} onSave={setConfig} />
            <ReplaceModal show={modals.replace} onClose={() => setModals(m => ({ ...m, replace: false }))} onReplace={handleReplace} data={data} />
            <ClearAllModal show={modals.clearAll} onClose={() => setModals(m => ({ ...m, clearAll: false }))} onConfirm={clearAllContent} />
            <ExportModal show={modals.export} onClose={() => setModals(m => ({ ...m, export: false }))} onExport={handleExport} />
            
            <BatchModal show={modals.batch} onClose={() => setModals(m => ({ ...m, batch: false }))} onStart={(f) => handleBatchStart(f, 'basic')} title="üå∏ ÊâπÈáèÁøªËØëÂü∫Á°ÄÂ≠óÊÆµ" fields={{ name: true, description: true, personality: true, scenario: true, first_message: true, message_example: true, tags: true }} />
            <BatchModal show={modals.advanced} onClose={() => setModals(m => ({ ...m, advanced: false }))} onStart={(f) => handleBatchStart(f, 'advanced')} title="üå∏ ÊâπÈáèÁøªËØëÈ´òÁ∫ßÂ≠óÊÆµ" fields={{ system_prompt: true, post_history_instructions: true, creator_notes: true, alternate_greetings: true }} />
            <BatchModal show={modals.worldbook} onClose={() => setModals(m => ({ ...m, worldbook: false }))} onStart={(f) => handleBatchStart(f, 'worldbook')} title="üå∏ ÊâπÈáèÁøªËØë‰∏ñÁïå‰π¶" fields={Object.fromEntries((data?.book_entries || []).map(e => [e.name, true]))} />

            <TranslateModal show={modals.compare} onClose={() => !translating && setModals(m => ({ ...m, compare: false }))} items={compareItems} onApply={applyTranslation} translating={translating} progress={progress} />
            
            <FullEditorModal 
              show={fullEditor.show} 
              onClose={() => setFullEditor({ show: false, field: '', title: '' })} 
              title={`üìù ${fullEditor.title}`}
              value={data?.[fullEditor.field] || ''} 
              onChange={(val) => updateField(fullEditor.field, val)} 
            />
          </>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
